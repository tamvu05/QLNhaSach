CREATE DATABASE QLNhaSach;

USE QLNhaSach;

CREATE TABLE TacGia (
	MaTG INT AUTO_INCREMENT PRIMARY KEY,
    TenTG VARCHAR(200),
    MoTa TEXT
);

CREATE TABLE NhaXuatBan (
	MaNXB INT AUTO_INCREMENT PRIMARY KEY,
    TenNXB VARCHAR(200) UNIQUE,
    MoTa TEXT
);

CREATE TABLE TheLoai (
	MaTL INT AUTO_INCREMENT PRIMARY KEY,
    TenTL VARCHAR(200) UNIQUE,
    MoTa TEXT
);

CREATE TABLE Sach (
    MaSach INT AUTO_INCREMENT PRIMARY KEY,
    TenSach VARCHAR(200),
    ISBN VARCHAR(13) UNIQUE,
    MaTG INT,
    MaNXB INT,
    MaTL INT,
    SoLuongTon INT DEFAULT 0,
    DonGia DECIMAL(19,4),
    HinhAnh TEXT,
    HinhAnhID VARCHAR(255),
    MoTa TEXT,
    FOREIGN KEY (MaTG) REFERENCES TacGia(MaTG),
    FOREIGN KEY (MaTL) REFERENCES TheLoai(MaTL),
    FOREIGN KEY (MaNXB) REFERENCES NhaXuatBan(MaNXB)
);

CREATE TABLE TaiKhoan (
	MaTK INT AUTO_INCREMENT PRIMARY KEY,
	TenDangNhap VARCHAR(200) UNIQUE,
    MatKhauHash VARCHAR(500),
    TrangThai ENUM('ACTIVE', 'INACTIVE', 'LOCKED', 'DELETED') DEFAULT 'ACTIVE',
    MaVT ENUM(1, 2, 3, 4),
    ResetToken VARCHAR(255),
    TokenExp DATETIME
);

CREATE TABLE KhachHang (
	MaKH INT AUTO_INCREMENT PRIMARY KEY,
    MaTK INT,
    HoTen VARCHAR(200),
    DiaChi VARCHAR(500),
    SDT VARCHAR(15),
    Email VARCHAR(200),
    FOREIGN KEY (MaTK) REFERENCES TaiKhoan(MaTK)
);

CREATE TABLE NhanVien (
	MaNV INT AUTO_INCREMENT PRIMARY KEY,
	MaTK INT,
    HoTen VARCHAR(200),
    NgaySinh DATETIME,
    SDT VARCHAR(15),
    NgayVaoLam DATETIME,
    HinhAnh VARCHAR(500),
    HinhAnhID VARCHAR(500),
    FOREIGN KEY (MaTK) REFERENCES TaiKhoan(MaTK)
);

CREATE TABLE NhaCungCap (
	MaNCC INT AUTO_INCREMENT PRIMARY KEY,
	TenNCC VARCHAR(200),
    DiaChi VARCHAR(500),
    SDT VARCHAR(15)
);

CREATE TABLE PhieuNhap (
	MaPN INT AUTO_INCREMENT PRIMARY KEY,
    MaNCC INT,
    MaNV INT,
	NgayNhap DATETIME,
    NoiDung TEXT,
    TrangThai ENUM('HIEU_LUC', 'DA_HUY') DEFAULT 'HIEU_LUC';
    FOREIGN KEY (MaNCC) REFERENCES NhaCungCap(MaNCC),
    FOREIGN KEY (MaNV) REFERENCES NhanVien(MaNV)
);

CREATE TABLE PhieuXuat (
	MaPX INT AUTO_INCREMENT PRIMARY KEY,
    MaNV INT,
	NgayXuat DATETIME,
    NoiDung TEXT,
    TrangThai ENUM('HIEU_LUC', 'DA_HUY') DEFAULT 'HIEU_LUC';
	FOREIGN KEY (MaNV) REFERENCES NhanVien(MaNV)
);

CREATE TABLE CTPhieuNhap (
	MaPN INT,
    MaSach INT,
	SoLuong INT DEFAULT 1,
    DonGiaNhap DECIMAL(19,4),
    FOREIGN KEY (MaPN) REFERENCES PhieuNhap(MaPN),
    FOREIGN KEY (MaSach) REFERENCES Sach(MaSach),
    PRIMARY KEY (MaPN, MaSach)
);


CREATE TABLE CTPhieuXuat (
	MaPX INT,
    MaSach INT,
	SoLuong INT DEFAULT 1,
    DonGiaXuat DECIMAL(19,4),
    FOREIGN KEY (MaPX) REFERENCES PhieuXuat(MaPX),
    FOREIGN KEY (MaSach) REFERENCES Sach(MaSach),
    PRIMARY KEY (MaPX, MaSach)
);

CREATE TABLE DonHang (
    MaDH INT AUTO_INCREMENT PRIMARY KEY,
    MaKH INT NULL,
    NgayDat TIMESTAMP DEFAULT CURRENT_TIMESTAMP, 
    TongTien DECIMAL(19,4) DEFAULT 0,
    TenNguoiNhan VARCHAR(200),
    DiaChiNhan VARCHAR(500),
    SDT VARCHAR(20),
    GhiChu TEXT,
    MaVC VARCHAR(50),
    HinhThucThanhToan ENUM('COD', 'MOMO', 'BANK_TRANSFER') DEFAULT 'COD',
    TrangThai ENUM('CHO_XAC_NHAN', 'DANG_CHUAN_BI_HANG', 'DA_GIAO_CHO_DON_VI_VAN_CHUYEN', 'DA_GIAO', 'DA_HUY', 'DA_HOAN_TRA') DEFAULT 'CHO_XAC_NHAN',
    FOREIGN KEY (MaKH) REFERENCES KhachHang(MaKH),
    FOREIGN KEY (MaVC) REFERENCES Voucher(MaVC)
);

CREATE TABLE CTDonHang (
    MaDH INT,       
    MaSach INT,
    SoLuong INT,
    DonGia DECIMAL(19,4), 
    PRIMARY KEY (MaDH, MaSach),
    FOREIGN KEY (MaDH) REFERENCES DonHang(MaDH) ON DELETE CASCADE,
    FOREIGN KEY (MaSach) REFERENCES Sach(MaSach)
);

CREATE TABLE HoaDon (
	MaHD INT AUTO_INCREMENT PRIMARY KEY,
    MaDH INT NULL,
    MaNV INT NULL,
    NgayTaoHoaDon TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    TongTien DECIMAL(19,4) DEFAULT 0,
    TenKhachHang VARCHAR(200) DEFAULT 'Khách lẻ',
    SDTKhachHang VARCHAR(20),
    GhiChu TEXT,
    HinhThucThanhToan ENUM('CASH', 'BANK_TRANSFER') DEFAULT 'CASH',
    TrangThai ENUM('CHO_THANH_TOAN', 'DA_THANH_TOAN', 'DA_HUY', 'DA_HOAN_TRA') DEFAULT 'CHO_THANH_TOAN',
    FOREIGN KEY (MaNV) REFERENCES NhanVien(MaNV),
    FOREIGN KEY (MaDH) REFERENCES DonHang(MaDH)
);

CREATE TABLE CTHoaDon (
    MaHD INT,       
    MaSach INT,
    SoLuong INT,
    DonGia DECIMAL(19,4), 
    PRIMARY KEY (MaHD, MaSach),
    FOREIGN KEY (MaHD) REFERENCES HoaDon(MaHD) ON DELETE CASCADE,
    FOREIGN KEY (MaSach) REFERENCES Sach(MaSach)
);

CREATE TABLE GioHang (
    MaKH INT,       
    MaSach INT,
    SoLuong INT,
    NgayThem TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (MaKH, MaSach),
    FOREIGN KEY (MaKH) REFERENCES KhachHang(MaKH),
    FOREIGN KEY (MaSach) REFERENCES Sach(MaSach)
);

CREATE TABLE Voucher (    
    MaVC VARCHAR(50) PRIMARY KEY,
    SoLuong INT DEFAULT 1,
    NgayBD TIMESTAMP,
    NgayKT TIMESTAMP,
    LoaiVC ENUM('PHAN_TRAM', 'SO_TIEN') DEFAULT 'SO_TIEN',
    GiaTriGiam DECIMAL(19, 4),
    SoTienGiamMax DECIMAL(19, 4),
    DKTongTien DECIMAL(19, 4),
    SLDaDung INT DEFAULT 0,
    TrangThai ENUM('HOAT_DONG', 'VO_HIEU') DEFAULT 'HOAT_DONG'
);

CREATE TABLE LichSuDungVoucher (
	id INT AUTO_INCREMENT PRIMARY KEY,
    MaVC VARCHAR(50),       
    MaKH INT,       
    MaDH int,
    NgaySuDung DATETIME,
    FOREIGN KEY (MaVC) REFERENCES Voucher(MaVC),
    FOREIGN KEY (MaKH) REFERENCES KhachHang(MaKH),
    FOREIGN KEY (MaDH) REFERENCES DonHang(MaDH)
);

-- Create Index 
CREATE INDEX idx_sach_tensach ON Sach(TenSach);
CREATE INDEX idx_tacgia_tentacgia ON TacGia(TenTG);
CREATE INDEX idx_theloai_tentheloai ON TheLoai(TenTL);
CREATE INDEX idx_nhaxuatban_tennhaxuatban ON NhaXuatBan(TenNXB);


















