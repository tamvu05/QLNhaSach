<%
const account = locals.account || {}

const user = {
    fullName: account.TenNV || 'N/A',
    email: account.Email || 'N/A',
    role: account.VaiTro ? (account.VaiTro > 3 ? 'Quản lý' : 'Nhân viên') : 'Không xác định',
    phone: account.SDT || 'N/A',
    joinDate: account.NgayVaoLam ? new Date(account.NgayVaoLam).toLocaleDateString('vi-VN') : 'N/A',
    employeeId: account.MaNV || 'N/A',
    dateOfBirth: account.NgaySinh ? new Date(account.NgaySinh).toLocaleDateString('vi-VN') : 'N/A',
    avatar: account.HinhAnh || null,
}
const isManager = Number(account?.VaiTro) > 3
%>

<div class="container-fluid profile-page py-3">
    <div class="row g-4 align-items-start">
        <!-- Left: Avatar + Quick facts -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center py-5 d-flex flex-column gap-3">
                    <div>
                        <div class="avatar-wrap mx-auto mb-3" id="avatar-wrapper">
                            <% if (user.avatar) { %>
                                <img src="<%= user.avatar %>" alt="Avatar" class="avatar-img" id="avatar-image">
                            <% } else { %>
                                <div class="avatar-placeholder" id="avatar-placeholder">
                                    <span><%= user.fullName?.slice(0,1) || 'N' %></span>
                                </div>
                            <% } %>
                        </div>
                        <h4 class="fw-bold mb-1"><%= user.fullName %></h4>
                        <span class="badge bg-primary px-3 py-2 text-uppercase">Vai trò: <%= user.role %></span>
                    </div>
                    <div class="small text-muted">
                        Mã NV: <strong><%= user.employeeId %></strong>
                    </div>
                    <div class="small text-muted">
                        Ngày vào làm: <strong><%= user.joinDate %></strong>
                    </div>
                    <div class="d-grid gap-2 mt-2">
                        <input type="file" accept="image/*" id="avatar-input" class="d-none">
                        <button class="btn btn-outline-primary" id="change-avatar-btn">
                            <i class="fas fa-camera me-2"></i> Đổi ảnh đại diện
                        </button>
                        <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                            <i class="fas fa-key me-2"></i> Đổi mật khẩu
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Details -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-bottom d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="mb-0">Hồ sơ nhân viên</h5>
                        <small class="text-muted">Các trường khóa với nhân viên, quản lý có thể chỉnh.</small>
                    </div>
                </div>
                <div class="card-body p-4">
                    <form id="admin-profile-form">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label text-uppercase small fw-bold text-muted">Email</label>
                                <input type="email" class="form-control" name="Email" value="<%= user.email %>" <%= isManager ? '' : 'readonly' %>>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label text-uppercase small fw-bold text-muted">Họ và tên</label>
                                <input type="text" class="form-control" name="HoTen" value="<%= user.fullName %>">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-uppercase small fw-bold text-muted">Số điện thoại</label>
                                <input type="tel" class="form-control" name="SDT" value="<%= user.phone %>">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label text-uppercase small fw-bold text-muted">Ngày sinh</label>
                                <input type="date" class="form-control" name="NgaySinh" value="<%= account.NgaySinh ? account.NgaySinh.toISOString ? account.NgaySinh.toISOString().slice(0,10) : new Date(account.NgaySinh).toISOString().slice(0,10) : '' %>">
                            </div>
                            <!-- Ngày vào làm ẩn khỏi form theo yêu cầu -->
                        </div>

                        <div class="d-flex gap-2 justify-content-end mt-4">
                            <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal đổi mật khẩu -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Đổi mật khẩu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="change-password-form">
                    <div class="mb-3">
                        <label class="form-label text-uppercase small fw-bold text-muted">Mật khẩu hiện tại</label>
                        <input type="password" class="form-control" name="currentPassword" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-uppercase small fw-bold text-muted">Mật khẩu mới</label>
                        <input type="password" class="form-control" name="newPassword" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-uppercase small fw-bold text-muted">Nhập lại mật khẩu mới</label>
                        <input type="password" class="form-control" name="confirmPassword" required>
                    </div>
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="reset" class="btn btn-outline-secondary">Hủy</button>
                        <button type="submit" class="btn btn-danger">Đổi mật khẩu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="/js/profile.admin.js"></script>

<style>
    .avatar-wrap {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        background: radial-gradient(circle at 30% 30%, #7aa0ff, #3e4da7);
        box-shadow: 0 10px 25px rgba(62, 77, 167, 0.35);
        overflow: hidden;
        cursor: pointer;
    }

    .avatar-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-placeholder {
        color: #fff;
        font-size: 42px;
        font-weight: 700;
    }

    .info-box {
        border: 1px solid #e6e9f2;
        border-radius: 10px;
        padding: 12px 14px;
        display: flex;
        gap: 10px;
        align-items: center;
        background: #fff;
        position: relative;
    }

    .info-box.readonly {
        background: #f7f8fb;
        color: #6c757d;
    }

    .lock-note {
        font-size: 11px;
        color: #6c757d;
        margin-left: auto;
    }

    .info-box i {
        width: 20px;
        text-align: center;
    }

    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    }
</style>
